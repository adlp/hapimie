{% extends "base.html" %}

{% block title %}‚òéÔ∏è  Endpoints{% endblock %}

{% block content %}
<h1>Vue des postes</h1>
<div id="conteneur"></div>

<div id="popup" class="popup" style="display:none;">
  <span class="popup-close" onclick="closePopup()">‚ùå</span>
    <h3>Info Endpoint</h3>
    <pre id="popup-content"></pre>
</div>

<style>
    .poste {
        display: inline-block;
        width: 120px;
        height: 40px;
        margin: 05px;
        padding: 10px;
        text-align: center;
        vertical-align: middle;
        border-radius: 8px;
        cursor: pointer;
        color: white;
        font-weight: bold;
    }
    .up { background-color: green; }
    .down { background-color: red; }
    .groupe { margin-top: 30px; }
    .anchors a {
        margin-right: 15px;
        font-weight: bold;
        text-decoration: none;
        color: #0077cc;
    }
</style>

<script>
    const nom = "{{ nom }}";
    const groupe = "{{ groupe }}";

    console.log("nom r√©cup√©r√©s :", nom);
    console.log("Groupe r√©cup√©r√©s :", groupe);

    async function chargerDonnees() {
        const [grpRes, endRes] = await Promise.all([
            fetch("/api/endpointPerGrp").then(r => r.json()),
            fetch("/api/endpoints").then(r => r.json())
        ]);

        const conteneur = document.getElementById("conteneur");
        conteneur.innerHTML = "";

        if (!nom || nom.trim() === "") {
            conteneur.innerHTML = "<h2>Choisissez un groupe principal :</h2>";
            for (const cle of Object.keys(grpRes)) {
                const lien = document.createElement("a");
                lien.href = `/endpoints/${encodeURIComponent(cle)}`;
                lien.textContent = cle;
                lien.style.display = "block";
                lien.style.margin = "10px 0";
                lien.style.fontSize = "18px";
                conteneur.appendChild(lien);
            }
            return;
        }

        const groupes = grpRes[nom] || {};
        const endpoints = endRes;

        // üîó Liste des ancres si groupe non pr√©cis√©
        if (!groupe) {
            const anchorBar = document.createElement("div");
            anchorBar.className = "anchors";
            anchorBar.innerHTML = "<h2>Acc√®s rapide :</h2>";
            for (const sousGroupe of Object.keys(groupes)) {
                const a = document.createElement("a");
                a.href = `#${encodeURIComponent(sousGroupe)}`;
                a.textContent = sousGroupe;
                anchorBar.appendChild(a);
            }
            conteneur.appendChild(anchorBar);
        }

        for (const [sousGroupe, postes] of Object.entries(groupes)) {
            if (groupe && sousGroupe !== groupe) continue;

            const bloc = document.createElement("div");
            bloc.className = "groupe";
            bloc.id = sousGroupe; // üîó ancre HTML
            bloc.innerHTML = `<h2>${sousGroupe}</h2>`;

            const postesInfos = postes
                .map(p => ({ id: p, ...endpoints[p] }))
                .filter(p => p.ObjectName)
                .sort((a, b) => a.ObjectName.localeCompare(b.ObjectName));

            for (const poste of postesInfos) {
                const div = document.createElement("div");
                div.className = `poste ${poste.Up ? "up" : "down"}`;
                div.textContent = poste.ObjectName;
                div.onclick = () => {
                    document.getElementById("popup-content").textContent = JSON.stringify(poste, null, 2);
                    document.getElementById("popup").style.display = "block";
                };
                bloc.appendChild(div);
            }

            conteneur.appendChild(bloc);
        }
    }



  function showPopup(id) {
    fetch("/api/status")
      .then(res => res.json())
      .then(apir => {
        const data = apir.Channels[id];
        document.getElementById("popup-content").textContent = JSON.stringify(data, null, 2);
        document.getElementById("popup").style.display = "block";
      });
  }

  function closePopup() {
    document.getElementById("popup").style.display = "none";
  }


    chargerDonnees();
</script>
{% endblock %}
