{% extends "base.html" %}

{% block title %}☎️  Endpoints{% endblock %}

{% block content %}
<h1>Vue des postes</h1>
<div id="conteneur"></div>

<div id="popup" class="popup" style="display:none;">
  <span class="popup-close" onclick="closePopup()">❌</span>
    <pre id="popup-content"></pre>
</div>

<div id="ipopup" class="popup" style="display:none;">
    <span class="popup-close" onclick="document.getElementById('popup').style.display='none'">X</span>
  <h3>Détails du poste</h3>
  <pre id="popup-content"></pre>
</div>

<style>
    .poste {
        display: inline-block;
        width: 120px;
        height: 80px;
        margin: 10px;
        padding: 10px;
        text-align: center;
        vertical-align: middle;
        border-radius: 8px;
        cursor: pointer;
        color: white;
        font-weight: bold;
    }
    .up { background-color: green; }
    .down { background-color: red; }
    .groupe { margin-top: 30px; }
</style>

<script>
    //const params = new URLSearchParams(window.location.search);
    //const nom = params.get("nom");
    //const groupe = params.get("groupe");
    //const nom = "PhoneSiteNom";
    //const groupe = "Strasbourg";
    const nom = "{{ nom }}";
    const groupe = "{{ groupe }}";

    //const groupes = nom ? grpRes[nom] : {};
    console.log("nom récupérés :", nom);
    console.log("Groupe récupérés :", groupe);
    //console.log("Groupes récupérés :", groupes);

    async function chargerDonnees() {
        const [grpRes, endRes] = await Promise.all([
            fetch("/api/endpointPerGrp").then(r => r.json()),
            fetch("/api/endpoints").then(r => r.json())
        ]);

        const groupes = nom ? grpRes[nom] : {};
        const endpoints = endRes;

        const conteneur = document.getElementById("conteneur");
        conteneur.innerHTML = "";

        for (const [sousGroupe, postes] of Object.entries(groupes)) {
            if (groupe && sousGroupe !== groupe) continue;
            console.log("Postes du groupe", sousGroupe, postes);

            const bloc = document.createElement("div");
            bloc.className = "groupe";
            bloc.innerHTML = `<h2>${sousGroupe}</h2>`;

            const postesInfos = postes
                .map(p => ({ id: p, ...endpoints[p] }))
                .filter(p => p.ObjectName)
                .sort((a, b) => a.ObjectName.localeCompare(b.ObjectName));

            for (const poste of postesInfos) {
                const div = document.createElement("div");
                div.className = `poste ${poste.Up ? "up" : "down"}`;
                div.textContent = poste.ObjectName;
                div.onclick = () => {
                    document.getElementById("popup-content").textContent = JSON.stringify(poste, null, 2);
                    document.getElementById("popup").style.display = "block";
                };
                bloc.appendChild(div);
            }

            conteneur.appendChild(bloc);
        }
    }

  function showPopup(id) {
    fetch("/api/status")
      .then(res => res.json())
      .then(apir => {
        const data = apir.Channels[id];
        document.getElementById("popup-content").textContent = JSON.stringify(data, null, 2);
        document.getElementById("popup").style.display = "block";
      });
  }

  function closePopup() {
    document.getElementById("popup").style.display = "none";
  }


    chargerDonnees();
</script>
{% endblock %}
