{% extends "base.html" %}
{% block title %}Composer un appel{% endblock %}

{% block content %}
  <h2>üìû Composer un appel</h2>

  <form onsubmit="event.preventDefault(); lancerAppel();">
    <label for="appellant">Appelant :</label><br>
    <select id="appellant" name="appellant"></select><br><br>

    <div id="customAppelant" style="display:none;">
      <label for="custom">Appelant personnalis√© :</label><br>
      <input type="text" id="custom" placeholder="Saisir un appelant"><br><br>
    </div>

    <label for="numero">Num√©ro √† appeler :</label><br>
    <input type="text" id="numero" required><br><br>

    <button type="submit">üì≤ Appeler</button>
  </form>

  <div id="result"></div>

  <script>
    const select = document.getElementById("appellant");
    const customDiv = document.getElementById("customAppelant");
    const customInput = document.getElementById("custom");
    const resultDiv = document.getElementById("result");
    let currentChannel = null;

    async function chargerAppelants() {
      try {
        const res = await fetch("/api/myphones", { credentials: "include" });
        const phones = await res.json();
        phones.forEach(phone => {
          const opt = document.createElement("option");
          opt.value = phone;
          opt.textContent = phone === "_" ? "Autre‚Ä¶" : phone;
          select.appendChild(opt);
        });
        select.addEventListener("change", () => {
          customDiv.style.display = select.value === "_" ? "block" : "none";
        });
      } catch (err) {
        console.error("Erreur chargement appelants :", err);
      }
    }

    async function lancerAppel() {
      const appellant = select.value === "_" ? customInput.value : select.value;
      const numero = document.getElementById("numero").value;

      try {
        const res = await fetch("/api/dial", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ appellant, numero })
        });
        const data = await res.json();
        currentChannel = data.channel;

        resultDiv.innerHTML = `
          <h3>‚úÖ Appel lanc√©</h3>
          <p><strong>Login :</strong> ${data.login}</p>
          <p><strong>Appelant :</strong> ${data.appellant}</p>
          <p><strong>Num√©ro :</strong> ${data.numero}</p>
          <p><strong>Statut :</strong> ${data.status}</p>
          ${data.status === "Success" && data.channel ? `
            <button onclick="raccrocher()">üî¥ Raccrocher</button>
          ` : ""}
        `;
      } catch (err) {
        resultDiv.textContent = "‚ùå Erreur lors de l'appel.";
      }
    }

    async function raccrocher() {
      if (!currentChannel) return;
      try {
        await fetch("/api/HangUp", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ channel_id: currentChannel['Channel'] })
        });
        location.reload(); // üîÑ Recharge la page apr√®s raccrochage
      } catch (err) {
        alert("Erreur lors du raccrochage.");
      }
    }

    chargerAppelants();
  </script>
{% endblock %}
