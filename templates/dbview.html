{% extends "base.html" %}

{% block title %}üóÉÔ∏è Base de donn√©es{% endblock %}

{% block content %}
<h1>üóÇÔ∏è √âditeur de base de donn√©es</h1>

<input type="text" id="search" placeholder="üîç Rechercher une cl√© ou une valeur..." style="width: 100%; padding: 8px; margin-bottom: 20px; font-size: 16px;">

<div id="tree-container"></div>

<div id="popup" class="popup">
    <span class="popup-close" onclick="document.getElementById('popup').style.display='none'">X</span>
    <pre id="popup-content"></pre>
</div>

<style>
    .node {
        margin-left: 20px;
        padding: 5px;
        border-left: 1px solid #ccc;
    }
    .key {
        font-weight: bold;
        margin-right: 10px;
    }
    .leaf {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 5px 0;
        flex-wrap: wrap;
    }
    input[type="text"] {
        padding: 4px;
        font-size: 14px;
        min-width: 150px;
    }
    button {
        padding: 4px 8px;
        font-size: 13px;
        cursor: pointer;
    }
    .branch-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px 0;
    }
    .popup {
        position: fixed;
        top: 20%;
        left: 30%;
        width: 40%;
        background: #fff;
        border: 2px solid #333;
        padding: 20px;
        display: none;
        z-index: 1000;
    }
    .popup-close {
        float: right;
        cursor: pointer;
        font-weight: bold;
    }
    @media (max-width: 600px) {
        .leaf {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>

<script>
    async function fetchData() {
        const res = await fetch("/api/dbGet");
        const data = await res.json();
        const container = document.getElementById("tree-container");
        container.innerHTML = "";
        renderTree(data, [], container);
    }

    function renderTree(obj, path, container) {
        for (const key in obj) {
            const fullPath = [...path, key];
            const value = obj[key];
            const node = document.createElement("div");
            node.className = "node";

            if (typeof value === "string") {
                const leaf = document.createElement("div");
                leaf.className = "leaf";

                const label = document.createElement("span");
                label.className = "key";
                label.textContent = key;

                const input = document.createElement("input");
                input.type = "text";
                input.value = value;

                const saveBtn = document.createElement("button");
                saveBtn.textContent = "Modifier";
                saveBtn.onclick = () => {
                    fetch("/api/dbPut", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            path: fullPath.join("/"),
                            value: input.value
                        })
                    }).then(() => alert("‚úÖ Valeur modifi√©e"));
                };

                const delBtn = document.createElement("button");
                delBtn.textContent = "üóëÔ∏è Supprimer";
                delBtn.onclick = () => {
                    if (confirm("Confirmer la suppression de cette feuille ?")) {
                        fetch("/api/dbDel", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ path: fullPath.join("/") })
                        }).then(() => {
                            alert("üóëÔ∏è Feuille supprim√©e");
                            leaf.remove();
                        });
                    }
                };

                leaf.appendChild(label);
                leaf.appendChild(input);
                leaf.appendChild(saveBtn);
                leaf.appendChild(delBtn);
                node.appendChild(leaf);
            } else if (typeof value === "object") {
                const header = document.createElement("div");
                header.className = "branch-header";

                const label = document.createElement("span");
                label.className = "key";
                label.textContent = key;

                const toggleBtn = document.createElement("button");
                toggleBtn.textContent = "‚Üï";
                toggleBtn.onclick = () => {
                    subtree.style.display = subtree.style.display === "none" ? "block" : "none";
                };

                const delBtn = document.createElement("button");
                delBtn.textContent = "üóëÔ∏è Supprimer branche";
                delBtn.onclick = () => {
                    if (confirm("Confirmer la suppression de cette branche ?")) {
                        fetch("/api/dbDel", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ path: fullPath.join("/") })
                        }).then(() => {
                            alert("üóëÔ∏è Branche supprim√©e");
                            node.remove();
                        });
                    }
                };

                header.appendChild(label);
                header.appendChild(toggleBtn);
                header.appendChild(delBtn);
                node.appendChild(header);

                const subtree = document.createElement("div");
                subtree.className = "node";
                subtree.style.display = "none"; // üëà branche repli√©e par d√©faut
                renderTree(value, fullPath, subtree);
                node.appendChild(subtree);


            }

            container.appendChild(node);
        }
    }

    document.getElementById("search").oninput = function() {
        const term = this.value.toLowerCase();
        document.querySelectorAll(".node").forEach(node => {
            node.style.display = node.textContent.toLowerCase().includes(term) ? "block" : "none";
        });
    };

    fetchData();
</script>
{% endblock %}
